# PostgreSQL Database Rules for AdLocal Rails Application

## General Database Principles

### Naming Conventions
- Use **snake_case** for all table names, column names, and indexes
- Table names should be **plural** (e.g., `users`, `orders`, `order_items`)
- Join tables should be named alphabetically (e.g., `categories_products`, not `products_categories`)
- Foreign key columns should end with `_id` (e.g., `user_id`, `category_id`)
- Boolean columns should be prefixed with `is_`, `has_`, `can_`, or `should_` (e.g., `is_active`, `has_permission`)
- Timestamp columns should be `created_at` and `updated_at`

### Data Types
- Use `uuid` for primary keys when distributed systems are involved
- Use `bigint` for primary keys for better performance with large datasets
- Use `decimal` for monetary values with appropriate precision (e.g., `decimal(10,2)`)
- Use `text` instead of `varchar` unless you have specific length constraints
- Use `jsonb` for JSON data (better performance than `json`)
- Use `inet` for IP addresses
- Use `timestamptz` for timestamps (always store with timezone)

### Indexes
- Always create indexes on foreign key columns
- Create composite indexes for frequently queried column combinations
- Use partial indexes for conditional data (e.g., `WHERE is_active = true`)
- Consider `gin` indexes for JSONB columns
- Use `btree` indexes for range queries and sorting
- Monitor index usage and remove unused indexes

## Rails-Specific Rules

### Migrations
```ruby
# Good migration structure
class CreateUsers < ActiveRecord::Migration[8.0]
  def change
    create_table :users, id: :uuid do |t|
      t.string :email, null: false
      t.string :first_name, null: false
      t.string :last_name, null: false
      t.boolean :is_active, default: true, null: false
      t.timestamps
    end

    add_index :users, :email, unique: true
    add_index :users, :is_active
    add_index :users, [:first_name, :last_name]
  end
end
```

### Model Validations
- Always validate presence of required fields
- Use database constraints as backup for validations
- Validate email format and uniqueness
- Use strong parameters to prevent mass assignment

### Associations
- Use `dependent: :destroy` or `dependent: :restrict_with_error` appropriately
- Consider `dependent: :nullify` for optional associations
- Always define `belongs_to` associations with `optional: true` when appropriate

### Queries
- Use `includes` or `preload` to avoid N+1 queries
- Use `joins` for filtering, `includes` for accessing associated data
- Use `find_each` for large result sets instead of `find`
- Use `pluck` when you only need specific columns
- Use `select` to limit columns in queries

## Performance Guidelines

### Query Optimization
- Always use `EXPLAIN ANALYZE` for slow queries
- Avoid `SELECT *` in production code
- Use database views for complex queries
- Consider materialized views for expensive aggregations
- Use connection pooling (Rails handles this by default)

### Connection Management
- Use `with_connection` for custom database operations
- Be mindful of connection limits in multi-threaded environments
- Use read replicas for read-heavy operations when available

### Bulk Operations
- Use `insert_all` for bulk inserts
- Use `update_all` for bulk updates when appropriate
- Use `upsert` for insert-or-update operations
- Consider using `activerecord-import` gem for very large datasets

## Security Rules

### Data Protection
- Never store passwords in plain text (use `has_secure_password`)
- Encrypt sensitive data using Rails encryption
- Use environment variables for database credentials
- Implement proper backup and restore procedures
- Use SSL/TLS for database connections in production

### SQL Injection Prevention
- Always use parameterized queries
- Never interpolate user input directly into SQL
- Use Rails' built-in query methods instead of raw SQL when possible

## Monitoring and Maintenance

### Database Monitoring
- Monitor slow query logs
- Track database size and growth
- Monitor connection counts and pool usage
- Set up alerts for failed queries and long-running transactions

### Maintenance Tasks
- Regular `VACUUM` and `ANALYZE` operations (PostgreSQL handles this automatically)
- Monitor and clean up unused indexes
- Regular backup testing and restore procedures
- Monitor disk space usage

### Schema Evolution
- Always use reversible migrations
- Test migrations on production-like data
- Use `change_table` for multiple column modifications
- Consider data migration strategies for breaking changes

## Environment-Specific Rules

### Development
- Use smaller datasets for testing
- Enable query logging for debugging
- Use database seeds for consistent test data
- Consider using `database_cleaner` for tests

### Production
- Use read replicas for reporting queries
- Implement proper connection pooling
- Monitor and optimize slow queries
- Use database-level constraints as backup
- Implement proper backup and disaster recovery

## Common Anti-Patterns to Avoid

### Query Anti-Patterns
```ruby
# Bad: N+1 queries
users.each { |user| puts user.profile.name }

# Good: Use includes
User.includes(:profile).each { |user| puts user.profile.name }

# Bad: Loading unnecessary data
User.all.each { |user| puts user.email }

# Good: Use pluck
User.pluck(:email).each { |email| puts email }
```

### Migration Anti-Patterns
```ruby
# Bad: Irreversible migration
def up
  remove_column :users, :old_column
end

# Good: Reversible migration
def change
  remove_column :users, :old_column
end
```

### Model Anti-Patterns
```ruby
# Bad: Missing validations
class User < ApplicationRecord
  # No validations
end

# Good: Proper validations
class User < ApplicationRecord
  validates :email, presence: true, uniqueness: true
  validates :first_name, presence: true
  validates :last_name, presence: true
end
```

## Tools and Resources

### Useful Gems
- `pg` - PostgreSQL adapter
- `activerecord-import` - Bulk operations
- `database_cleaner` - Test database management
- `bullet` - N+1 query detection
- `pg_query` - Query analysis

### Monitoring Tools
- PostgreSQL's built-in `pg_stat_statements`
- Rails query logging
- Application Performance Monitoring (APM) tools
- Database monitoring dashboards

### Documentation
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Rails Database Guide](https://guides.rubyonrails.org/active_record_basics.html)
- [Rails Migration Guide](https://guides.rubyonrails.org/active_record_migrations.html)
